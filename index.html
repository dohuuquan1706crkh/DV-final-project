<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D3 â€” World Map with Search</title>
  <style>
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    #map { width:100%; height:100vh; display:block; }
    .country{ fill:#d8d8d8; stroke:#ffffff; stroke-width:0.5px; }
    .country:hover{ fill:#ffcc00; cursor:pointer; }
    .tooltip{
      position: absolute;
      padding: 6px 10px;
      background: rgba(0,0,0,0.75);
      color: #fff;
      font-size: 13px;
      border-radius: 4px;
      pointer-events: none;
      transform: translate(-50%, -120%);
      white-space: nowrap;
    }
    .controls{
      position: absolute;
      left: 12px;
      top: 12px;
      background: rgba(255,255,255,0.9);
      padding:8px;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
    }
    button{margin:2px}
    #searchBar{
      margin-top:4px;
      padding:4px 6px;
      width:160px;
      border:1px solid #ccc;
      border-radius:4px;
    }
  </style>
</head>
<script src="countryChart.js"></script>
<body>
  <div id="map"></div>
  <div id="pyramidContainer" style="display:none; position:absolute; top:80px; right:20px; background:white; padding:10px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.2); width:400px; height:300px; overflow:auto;">
  <h3 id="pyramidTitle"></h3>
  <div id="pyramidChart"></div>
</div>
  <div class="controls">
    <button id="reset">Reset</button>
    <button id="zoomIn">Zoom +</button>
    <button id="zoomOut">Zoom -</button><br>
    <input id="searchBar" type="text" placeholder="Search country..." />
  </div>
  <div id="tooltip" class="tooltip" style="display:none"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const width = Math.max(document.documentElement.clientWidth || 960, 960);
    const height = Math.max(document.documentElement.clientHeight || 600, 600);

    const svg = d3.select('#map')
      .append('svg')
      .attr('viewBox', `0 0 ${width} ${height}`)
      .style('width', '100%')
      .style('height', '100%')
      .style('display', 'block');

    const g = svg.append('g');

    const projection = d3.geoNaturalEarth1()
      .scale((width / 1.8) / Math.PI)
      .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);
    const tooltip = d3.select('#tooltip');
    const GEOJSON_URL = 'https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson';

    let countriesData = [];

    d3.json(GEOJSON_URL).then(world => {
      countriesData = world.features;
      drawMap(world);
    }).catch(err => {
      console.error('Failed to load GeoJSON:', err);
      svg.append('text').attr('x',20).attr('y',30).text('Failed to load world GeoJSON');
    });

    function drawMap(world) {
      g.selectAll('path')
        .data(world.features)
        .enter().append('path')
          .attr('class', 'country')
          .attr('d', path)
          .on('mouseover', (event, d) => {
            tooltip.style('display', 'block').text(d.properties.name || 'Unknown');
            d3.select(event.currentTarget).raise();
          })
          .on('mousemove', (event) => {
            tooltip.style('left', (event.pageX) + 'px')
                   .style('top', (event.pageY) + 'px');
          })
          .on('mouseout', () => tooltip.style('display', 'none'))
          .on('click', (event, d) => {
            const countryName = d.properties.name;
            window.location.href = `country.html?name=${encodeURIComponent(countryName)}`;
          });

      const graticule = d3.geoGraticule();
      g.append('path')
        .datum(graticule)
        .attr('d', path)
        .attr('fill', 'none')
        .attr('stroke', '#cfcfcf')
        .attr('stroke-width', 0.5);
    }

    // Zoom & pan
    const zoom = d3.zoom()
      .scaleExtent([1, 8])
      .on('zoom', (event) => {
        g.attr('transform', event.transform);
      });
    svg.call(zoom);

    d3.select('#reset').on('click', () => svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity));
    d3.select('#zoomIn').on('click', () => svg.transition().duration(350).call(zoom.scaleBy, 1.4));
    d3.select('#zoomOut').on('click', () => svg.transition().duration(350).call(zoom.scaleBy, 1/1.4));

    // Search feature
    const searchInput = d3.select('#searchBar');
    searchInput.on('keyup', (event) => {
      if (event.key === 'Enter') {
        const query = searchInput.property('value').toLowerCase();
        const country = countriesData.find(d => (d.properties.name || '').toLowerCase() === query);
        if (country) {
          const [[x0, y0], [x1, y1]] = path.bounds(country);
          const dx = x1 - x0, dy = y1 - y0;
          const x = (x0 + x1) / 2, y = (y0 + y1) / 2;
          const scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height)));
          const translate = [width / 2 - scale * x, height / 2 - scale * y];
          svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        } else {
          alert('Country not found');
        }
      }
    });
  </script>
</body>
</html>
